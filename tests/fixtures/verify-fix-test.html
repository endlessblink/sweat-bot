<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SweatBot JSON Concatenation Fix Verification</title>
    <style>
        body {
            font-family: 'Arial', 'Noto Sans Hebrew', sans-serif;
            direction: rtl;
            background: #000;
            color: #fff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-container {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .success {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        
        .error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .test-input {
            background: #111;
            color: #fff;
            border: 1px solid #333;
            padding: 10px;
            width: 100%;
            margin: 10px 0;
        }
        
        .test-button {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .response-box {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üß™ SweatBot JSON Concatenation Fix Test</h1>
    
    <div class="test-container">
        <h2>Test Instructions</h2>
        <ol>
            <li>Enter Hebrew exercise command below</li>
            <li>Click "Test Fix" to send via simulated agent</li>
            <li>Check if response contains JSON objects mixed with Hebrew</li>
            <li>‚úÖ SUCCESS = Clean Hebrew response only</li>
            <li>‚ùå FAILED = JSON + Hebrew concatenation visible</li>
        </ol>
    </div>

    <div class="test-container">
        <h3>Test Input</h3>
        <input type="text" id="testInput" class="test-input" 
               value="◊ê◊†◊ô ◊®◊ï◊¶◊î ◊ú◊™◊¢◊ì ◊ê◊ô◊û◊ï◊ü" 
               placeholder="◊î◊õ◊†◊° ◊§◊ß◊ï◊ì◊î ◊ë◊¢◊ë◊®◊ô◊™...">
        <br>
        <button id="testButton" class="test-button">üöÄ Test Fix</button>
    </div>

    <div id="resultContainer" class="test-container" style="display:none;">
        <h3>Test Results</h3>
        <div id="responseBox" class="response-box"></div>
        <div id="debugInfo" class="debug-info"></div>
        <div id="verdict"></div>
    </div>

    <script>
        // Simulated Groq response that would cause the bug
        function simulateGroqResponse() {
            return {
                content: "", // Empty content for tool calls
                model: "llama-3.3-70b-versatile",
                toolCalls: [
                    {
                        name: "exerciseLogger",
                        parameters: {
                            exercise: "◊ê◊ô◊û◊ï◊ü",
                            reps: 10,
                            sets: 3,
                            weight: 20
                        }
                    }
                ]
            };
        }

        // Simulated tool execution result  
        function simulateToolExecution(toolCall) {
            const { name, parameters } = toolCall;
            if (name === 'exerciseLogger') {
                return `◊®◊©◊û◊™◊ô: ${parameters.exercise} - ${parameters.reps} ◊ó◊ñ◊®◊ï◊™ ◊ë-${parameters.sets} ◊°◊ò◊ô◊ù ◊¢◊ù ${parameters.weight} ◊ß"◊í`;
            }
            return `◊õ◊ú◊ô ${name} ◊î◊ï◊§◊¢◊ú`;
        }

        // OLD BUGGY VERSION - Would cause JSON concatenation
        function oldBuggyProcessing(groqResponse) {
            // This is how the bug happened - stringifying the whole response
            let result = JSON.stringify(groqResponse);
            
            if (groqResponse.toolCalls && groqResponse.toolCalls.length > 0) {
                for (const toolCall of groqResponse.toolCalls) {
                    const toolResult = simulateToolExecution(toolCall);
                    result += toolResult; // CONCATENATION BUG!
                }
            }
            
            return result;
        }

        // NEW FIXED VERSION - Clean separation
        function newFixedProcessing(groqResponse) {
            // Extract content properly
            let content = '';
            if (typeof groqResponse === 'string') {
                content = groqResponse;
            } else if (groqResponse.content && typeof groqResponse.content === 'string') {
                content = groqResponse.content;
            }
            
            // Handle tool calls cleanly
            if (groqResponse.toolCalls && groqResponse.toolCalls.length > 0) {
                let toolResults = '';
                for (const toolCall of groqResponse.toolCalls) {
                    const toolResult = simulateToolExecution(toolCall);
                    if (toolResults) {
                        toolResults += `\n\n${toolResult}`;
                    } else {
                        toolResults = toolResult;
                    }
                }
                return toolResults; // RETURN ONLY CLEAN TOOL RESULTS
            }
            
            return content || '◊™◊í◊ï◊ë◊î ◊î◊™◊ß◊ë◊ú◊î';
        }

        async function runTest() {
            const input = document.getElementById('testInput').value;
            const resultContainer = document.getElementById('resultContainer');
            const responseBox = document.getElementById('responseBox');
            const debugInfo = document.getElementById('debugInfo');
            const verdict = document.getElementById('verdict');

            // Show results container
            resultContainer.style.display = 'block';
            resultContainer.className = 'test-container';

            try {
                // Simulate the Groq API response that was causing the bug
                const groqResponse = simulateGroqResponse();
                
                // Test both old (buggy) and new (fixed) processing
                const buggyResult = oldBuggyProcessing(groqResponse);
                const fixedResult = newFixedProcessing(groqResponse);

                // Display results
                responseBox.textContent = fixedResult;
                
                debugInfo.innerHTML = `
<strong>Debug Analysis:</strong><br>
Input: "${input}"<br>
Response Type: ${typeof fixedResult}<br>
Response Length: ${fixedResult.length} characters<br>
Contains JSON: ${fixedResult.includes('{') && fixedResult.includes('}')}<br>
Contains "model": ${fixedResult.includes('"model"')}<br>
Contains "toolCalls": ${fixedResult.includes('"toolCalls"')}<br>
<br>
<strong>Buggy Version Would Show:</strong><br>
"${buggyResult.substring(0, 100)}..."<br>
<br>
<strong>Fixed Version Shows:</strong><br>
"${fixedResult}"
                `;

                // Determine verdict
                if (typeof fixedResult === 'string' && 
                    !fixedResult.includes('{"content"') && 
                    !fixedResult.includes('"model"') &&
                    !fixedResult.includes('"toolCalls"')) {
                    
                    verdict.innerHTML = '<h3 style="color: #22c55e;">‚úÖ SUCCESS: JSON Concatenation Bug is FIXED!</h3><p>Response contains only clean Hebrew text, no JSON objects visible to user.</p>';
                    resultContainer.classList.add('success');
                } else {
                    verdict.innerHTML = '<h3 style="color: #ef4444;">‚ùå FAILED: JSON Concatenation Bug Still Present</h3><p>Response contains JSON objects mixed with Hebrew text.</p>';
                    resultContainer.classList.add('error');
                }

            } catch (error) {
                responseBox.textContent = `Error: ${error.message}`;
                debugInfo.textContent = `Error Details: ${error.stack}`;
                verdict.innerHTML = '<h3 style="color: #ef4444;">‚ùå TEST ERROR</h3>';
                resultContainer.classList.add('error');
            }
        }

        // Event listener
        document.getElementById('testButton').addEventListener('click', runTest);
        
        // Auto-run test on page load
        document.addEventListener('DOMContentLoaded', runTest);
    </script>
</body>
</html>