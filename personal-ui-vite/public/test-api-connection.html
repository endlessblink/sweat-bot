<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SweatBot API Connection Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #000; 
            color: #fff; 
            direction: rtl;
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border: 1px solid #333; 
            border-radius: 5px; 
        }
        .success { background: #1a4a1a; border-color: #4a7c59; }
        .error { background: #4a1a1a; border-color: #7c4a4a; }
        .warning { background: #4a3a1a; border-color: #7c6a4a; }
        button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover { background: #555; }
        #log { 
            background: #111; 
            padding: 20px; 
            margin-top: 20px; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🧪 SweatBot API Connection Test</h1>
    
    <div class="test-result">
        <h3>Environment Variables Check:</h3>
        <p id="env-check">Loading...</p>
    </div>

    <div class="test-result">
        <h3>Test Controls:</h3>
        <button onclick="testOpenAIConnection()">Test OpenAI Connection</button>
        <button onclick="testSweatBotAgent()">Test SweatBot Agent</button>
        <button onclick="testHebrewExercise()">Test Hebrew Exercise</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <script type="module">
        // Log function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Make log function global
        window.log = log;

        // Check environment variables
        function checkEnvironment() {
            const envCheck = document.getElementById('env-check');
            let envInfo = '';
            
            const openaiKey = import.meta.env.VITE_OPENAI_API_KEY;
            const groqKey = import.meta.env.VITE_GROQ_API_KEY;
            const geminiKey = import.meta.env.VITE_GEMINI_API_KEY;
            
            envInfo += `OpenAI Key: ${openaiKey ? openaiKey.substring(0, 20) + '...' : 'NOT FOUND'}\n`;
            envInfo += `Groq Key: ${groqKey ? groqKey.substring(0, 20) + '...' : 'NOT FOUND'}\n`;
            envInfo += `Gemini Key: ${geminiKey ? geminiKey.substring(0, 20) + '...' : 'NOT FOUND'}\n`;
            
            envCheck.textContent = envInfo;
            
            if (!openaiKey && !groqKey && !geminiKey) {
                envCheck.parentElement.className = 'test-result error';
                log('❌ No API keys found in environment variables', 'error');
            } else {
                envCheck.parentElement.className = 'test-result success';
                log('✅ API keys loaded from environment', 'success');
            }
        }

        // Test OpenAI connection
        window.testOpenAIConnection = async function() {
            log('🧪 Testing direct OpenAI connection...');
            
            const apiKey = import.meta.env.VITE_OPENAI_API_KEY;
            if (!apiKey) {
                log('❌ OpenAI API key not found', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: 'You are a test assistant. Reply in Hebrew.' },
                            { role: 'user', content: 'Hi, respond in Hebrew' }
                        ],
                        max_tokens: 50
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    log(`✅ OpenAI API working! Response: ${content}`, 'success');
                } else {
                    const errorData = await response.json();
                    log(`❌ OpenAI API error: ${response.status} - ${errorData.error?.message}`, 'error');
                }
            } catch (error) {
                log(`❌ OpenAI connection failed: ${error.message}`, 'error');
            }
        };

        // Test SweatBot Agent
        window.testSweatBotAgent = async function() {
            log('🧪 Testing SweatBot Agent...');
            
            try {
                // Import SweatBot agent
                const { getSweatBotAgent } = await import('../src/agent/index.ts');
                log('✅ SweatBot agent imported successfully', 'success');
                
                const agent = getSweatBotAgent();
                log('✅ SweatBot agent created', 'success');
                
                const status = agent.getStatus();
                log(`Agent status: ${JSON.stringify(status, null, 2)}`);
                
            } catch (error) {
                log(`❌ SweatBot agent test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Test Hebrew Exercise
        window.testHebrewExercise = async function() {
            log('🧪 Testing Hebrew exercise logging...');
            
            try {
                // Import SweatBot agent
                const { getSweatBotAgent } = await import('../src/agent/index.ts');
                const agent = getSweatBotAgent();
                
                log('📝 Sending: "עשיתי 4 טיפוסי חבל"');
                const response = await agent.chat('עשיתי 4 טיפוסי חבל');
                log(`🤖 Response: ${response}`, response.includes('רשמתי') ? 'success' : 'warning');
                
            } catch (error) {
                log(`❌ Hebrew exercise test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Clear log
        window.clearLog = function() {
            document.getElementById('log').textContent = '';
            log('Log cleared');
        };

        // Initialize
        checkEnvironment();
        log('🚀 SweatBot API Connection Test initialized');
        log('Environment variables checked. Click buttons above to run tests.');
    </script>
</body>
</html>